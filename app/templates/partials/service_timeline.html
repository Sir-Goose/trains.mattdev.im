<div class="journey-timeline">
    {% set all_previous = service.all_previous_stops %}
    {% set all_subsequent = service.all_subsequent_stops %}
    {% set ns = namespace(index=0, total=(all_previous|length) + 1 + (all_subsequent|length)) %}

    {% for stop in all_previous %}
    {% set ns.index = ns.index + 1 %}
    {% set stop_crs = (stop.crs or '')|trim|upper %}
    <div class="timeline-stop">
        <div class="timeline-marker">
            <div class="marker-icon marker-route">○</div>
            {% if ns.index < ns.total %}
            <div class="timeline-line"></div>
            {% endif %}
        </div>

        <div class="stop-details">
            <div class="stop-header">
                {% if stop_crs and stop_crs|length == 3 %}
                <a class="stop-link" href="/board/{{ stop_crs }}/departures">
                    <h3 class="stop-name">{{ stop.locationName }}</h3>
                </a>
                <a class="stop-crs stop-crs-link" href="/board/{{ stop_crs }}/departures">{{ stop_crs }}</a>
                {% else %}
                <h3 class="stop-name">{{ stop.locationName }}</h3>
                {% endif %}
            </div>

            <div class="stop-times">
                {% if stop.ata or stop.eta or stop.pta %}
                <div class="time-row">
                    <span class="time-label">Arrival:</span>
                    <span class="time-value">
                        {% if stop.ata and stop.ata|trim|lower not in ["on time", "no report"] %}
                            {{ stop.ata }} <span class="actual-badge">Actual</span>
                        {% elif stop.eta and stop.eta != "On time" %}
                            <span class="scheduled-time">{{ stop.pta or stop.st }}</span> → {{ stop.eta }}
                        {% else %}
                            {{ stop.pta or stop.st }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                {% if stop.at or stop.et or stop.st %}
                <div class="time-row">
                    <span class="time-label">Departure:</span>
                    <span class="time-value">
                        {% if stop.at and stop.at|trim|lower not in ["on time", "no report"] %}
                            {{ stop.at }} <span class="actual-badge">Actual</span>
                        {% elif stop.et and stop.et != "On time" %}
                            <span class="scheduled-time">{{ stop.st }}</span> → {{ stop.et }}
                        {% else %}
                            {{ stop.st }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}

    {% set ns.index = ns.index + 1 %}
    {% set service_crs = (service.crs or '')|trim|upper %}
    <div class="timeline-stop">
        <div class="timeline-marker">
            <div class="marker-icon marker-route">○</div>
            {% if ns.index < ns.total %}
            <div class="timeline-line"></div>
            {% endif %}
        </div>

        <div class="stop-details">
            <div class="stop-header">
                {% if service_crs and service_crs|length == 3 %}
                <a class="stop-link" href="/board/{{ service_crs }}/departures">
                    <h3 class="stop-name">{{ service.locationName }}</h3>
                </a>
                <a class="stop-crs stop-crs-link" href="/board/{{ service_crs }}/departures">{{ service_crs }}</a>
                {% else %}
                <h3 class="stop-name">{{ service.locationName }}</h3>
                {% endif %}
            </div>

            <div class="stop-times">
                {% if service.sta or service.eta or service.ata %}
                <div class="time-row">
                    <span class="time-label">Arrival:</span>
                    <span class="time-value">
                        {% if service.ata and service.ata|trim|lower not in ["on time", "no report"] %}
                            {{ service.ata }} <span class="actual-badge">Actual</span>
                        {% elif service.eta and service.eta != "On time" %}
                            <span class="scheduled-time">{{ service.sta }}</span> → {{ service.eta }}
                        {% else %}
                            {{ service.sta }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                {% if service.std or service.etd or service.atd %}
                <div class="time-row">
                    <span class="time-label">Departure:</span>
                    <span class="time-value">
                        {% if service.atd and service.atd|trim|lower not in ["on time", "no report"] %}
                            {{ service.atd }} <span class="actual-badge">Actual</span>
                        {% elif service.etd and service.etd != "On time" %}
                            <span class="scheduled-time">{{ service.std }}</span> → {{ service.etd }}
                        {% else %}
                            {{ service.std }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% for stop in all_subsequent %}
    {% set ns.index = ns.index + 1 %}
    {% set stop_crs = (stop.crs or '')|trim|upper %}
    <div class="timeline-stop">
        <div class="timeline-marker">
            <div class="marker-icon marker-route">○</div>
            {% if ns.index < ns.total %}
            <div class="timeline-line"></div>
            {% endif %}
        </div>

        <div class="stop-details">
            <div class="stop-header">
                {% if stop_crs and stop_crs|length == 3 %}
                <a class="stop-link" href="/board/{{ stop_crs }}/departures">
                    <h3 class="stop-name">{{ stop.locationName }}</h3>
                </a>
                <a class="stop-crs stop-crs-link" href="/board/{{ stop_crs }}/departures">{{ stop_crs }}</a>
                {% else %}
                <h3 class="stop-name">{{ stop.locationName }}</h3>
                {% endif %}
            </div>

            <div class="stop-times">
                {% if stop.pta or stop.st %}
                <div class="time-row">
                    <span class="time-label">Arrival:</span>
                    <span class="time-value">
                        {% if stop.ata and stop.ata|trim|lower not in ["on time", "no report"] %}
                            {{ stop.ata }} <span class="actual-badge">Actual</span>
                        {% elif stop.eta and stop.eta != "On time" %}
                            <span class="scheduled-time">{{ stop.pta or stop.st }}</span> → {{ stop.eta }}
                        {% else %}
                            {{ stop.pta or stop.st }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                {% if stop.st %}
                <div class="time-row">
                    <span class="time-label">Departure:</span>
                    <span class="time-value">
                        {% if stop.at and stop.at|trim|lower not in ["on time", "no report"] %}
                            {{ stop.at }} <span class="actual-badge">Actual</span>
                        {% elif stop.et and stop.et != "On time" %}
                            <span class="scheduled-time">{{ stop.st }}</span> → <span class="status-delayed">{{ stop.et }}</span>
                        {% else %}
                            {{ stop.st }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
